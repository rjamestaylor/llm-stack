services:
  # Auto-import tools on startup
  tool-importer:
    image: python:3.11-slim
    container_name: tool-importer
    volumes:
      - open-webui-data:/app/backend/data
      - ./exported_tools:/tmp/tools:ro
      - ./import-tools-to-db.py:/tmp/import-tools-to-db.py:ro
    command: >
      bash -c "
      echo 'üîÑ Tool auto-importer starting...' &&
      DB_PATH='/app/backend/data/webui.db' &&
      max_attempts=120 &&
      attempt=1 &&
      echo '‚è≥ Waiting for Open WebUI database...' &&
      while [ $$attempt -le $$max_attempts ]; do
        if [ -f \"$$DB_PATH\" ]; then
          echo 'üìÅ Database found!' &&
          break
        fi &&
        echo \"‚è≥ Waiting... ($$attempt/$$max_attempts)\" &&
        sleep 2 &&
        attempt=$$((attempt + 1))
      done &&
      if [ $$attempt -gt $$max_attempts ]; then
        echo '‚ùå Database timeout' &&
        exit 1
      fi &&
      echo 'üò¥ Waiting 15 seconds for database stability...' &&
      sleep 15 &&
      echo 'üì• Auto-importing tools...' &&
      python3 /tmp/import-tools-to-db.py /tmp/tools \"$$DB_PATH\" &&
      echo 'üéâ Auto-import completed successfully!'
      "
    depends_on:
      open-webui:
        condition: service_healthy
    restart: "no"

  open-webui:
    image: ghcr.io/open-webui/open-webui:ollama
    container_name: open-webui
    environment:
      - OLLAMA_API_BASE_URL=http://host.docker.internal:11434/api
      - OLLAMA_BASE_URL=http://host.docker.internal:11434
      - WEBUI_AUTH=false
      - ENABLE_SIGNUP=false
      - DEFAULT_USER_ROLE=admin
    ports:
      - "3000:8080"
    restart: always
    volumes:
      - open-webui-data:/app/backend/data
      - ollama-data:/root/.ollama
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 15s
      timeout: 10s
      retries: 10
      start_period: 60s

volumes:
  open-webui-data:
  ollama-data: